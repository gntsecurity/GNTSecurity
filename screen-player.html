<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Player - GNTS Signage</title>
    <link href="dist/output.css" rel="stylesheet">
</head>
<body class="flex items-center justify-center min-h-screen bg-black text-white">
    
    <div class="text-center">
        <h1 class="text-2xl font-bold mb-4">Loading Content...</h1>
        <div id="contentArea" class="w-full h-screen"></div>
    </div>

    <script type="module">
        import { supabase } from "./supabase.js";

        const urlParams = new URLSearchParams(window.location.search);
        const screenCode = urlParams.get("code");
        const contentArea = document.getElementById("contentArea");

        if (!screenCode) {
            contentArea.innerHTML = "<p class='text-red-400'>No screen code provided.</p>";
            throw new Error("No screen code provided.");
        }

        console.log(`Loading content for screen: ${screenCode}`);

        async function loadScheduledContent() {
            const now = new Date().toISOString();

            // Fetch the content based on the schedule
            const { data, error } = await supabase
                .from("schedules")
                .select("content_url")
                .eq("screen_code", screenCode)
                .lte("start_time", now)
                .gte("end_time", now)
                .single();

            if (error || !data) {
                contentArea.innerHTML = "<p class='text-red-400'>No scheduled content available.</p>";
                return;
            }

            displayContent(data.content_url);
        }

        function displayContent(contentUrl) {
            if (contentUrl.endsWith(".jpg") || contentUrl.endsWith(".png") || contentUrl.endsWith(".gif")) {
                contentArea.innerHTML = `<img src="${contentUrl}" class="w-full h-screen object-contain">`;
            } else if (contentUrl.endsWith(".mp4") || contentUrl.endsWith(".webm")) {
                contentArea.innerHTML = `
                    <video class="w-full h-screen" autoplay loop muted>
                        <source src="${contentUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>`;
            } else {
                contentArea.innerHTML = `<iframe src="${contentUrl}" class="w-full h-screen"></iframe>`;
            }
        }

        // Subscribe to real-time updates for content changes
        supabase
            .channel("screens")
            .on("postgres_changes", { event: "UPDATE", schema: "public", table: "screens", filter: `code=eq.${screenCode}` }, payload => {
                console.log("Screen content updated:", payload.new.content_url);
                displayContent(payload.new.content_url);
            })
            .subscribe();

        // Run this every minute to check for scheduled content
        setInterval(loadScheduledContent, 60000);
        loadScheduledContent();
    </script>

</body>
</html>
